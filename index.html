<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>MiniCraft 3D</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
html,body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  overflow:hidden;
  background:#87ceeb;
}
#stick{
  position:fixed;
  bottom:20px;
  left:20px;
  width:120px;
  height:120px;
  border-radius:50%;
  background:rgba(0,0,0,.3);
  z-index:10;
}
#knob{
  position:absolute;
  left:35px;
  top:35px;
  width:50px;
  height:50px;
  border-radius:50%;
  background:rgba(255,255,255,.8);
}
.btn{
  position:fixed;
  width:70px;
  height:70px;
  border-radius:50%;
  background:rgba(255,255,255,.8);
  z-index:10;
  font-size:14px;
}
#up{right:20px;bottom:20px;}
#down{right:20px;bottom:100px;}
#place{right:20px;bottom:180px;}
#break{right:20px;bottom:260px;}
#colorPicker{
  position:fixed;
  right:20px;
  bottom:340px;
  width:70px;
  height:40px;
  z-index:10;
}
</style>
</head>
<body>

<div id="stick"><div id="knob"></div></div>

<button class="btn" id="up">‚ñ≤</button>
<button class="btn" id="down">‚ñº</button>
<button class="btn" id="place">üß±</button>
<button class="btn" id="break">‚õè</button>
<input type="color" id="colorPicker" value="#3cb043">

<!-- THREE.JS —á–µ—Ä–µ–∑ HTTPS CDN -->
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>

<script>
let scene, camera, renderer;
let blocks = [];
let player = {x:0,y:0,z:10};
let yaw=0, pitch=0;
let mx=0, my=0, flyUp=false, flyDown=false;
let geom, currentColor;

init();
animate();

function init(){
  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x87ceeb);

  camera = new THREE.PerspectiveCamera(
    75,
    window.innerWidth / window.innerHeight,
    0.1,
    1000
  );

  scene.add(new THREE.AmbientLight(0xffffff,0.7));
  const sun = new THREE.DirectionalLight(0xffffff,0.8);
  sun.position.set(10,20,10);
  scene.add(sun);

  geom = new THREE.BoxGeometry(1,1,1);
  currentColor = document.getElementById("colorPicker").value;

  // –ü–æ–ª—è–Ω–∞ 90√ó90
  for(let x=-45;x<45;x++){
    for(let z=-45;z<45;z++){
      addBlock(x,0,z,"#3cb043");
    }
  }

  // 40 –¥–µ—Ä–µ–≤—å–µ–≤
  for(let i=0;i<40;i++){
    let x=Math.floor(Math.random()*80-40);
    let z=Math.floor(Math.random()*80-40);
    addTree(x,z);
  }

  setupControls();
}

function addBlock(x,y,z,color){
  const mat = new THREE.MeshLambertMaterial({color});
  const b = new THREE.Mesh(geom,mat);
  b.position.set(x,y,z);
  scene.add(b);
  blocks.push(b);
}

function addTree(x,z){
  for(let y=1;y<=4;y++) addBlock(x,y,z,"#8b5a2b");
  for(let lx=-2;lx<=2;lx++)
  for(let lz=-2;lz<=2;lz++)
  for(let ly=3;ly<=5;ly++){
    if(Math.random()>0.35)
      addBlock(x+lx,ly,z+lz,"#2e8b57");
  }
}

function setupControls(){
  const stick=document.getElementById("stick");
  const knob=document.getElementById("knob");

  stick.addEventListener("touchmove",e=>{
    const r=stick.getBoundingClientRect();
    const t=e.touches[0];
    mx=Math.max(-1,Math.min(1,(t.clientX-r.left-60)/40));
    my=Math.max(-1,Math.min(1,(t.clientY-r.top-60)/40));
    knob.style.left=35+mx*30+"px";
    knob.style.top=35+my*30+"px";
  });

  stick.addEventListener("touchend",()=>{
    mx=my=0;
    knob.style.left="35px";
    knob.style.top="35px";
  });

  document.getElementById("up").ontouchstart=()=>flyUp=true;
  document.getElementById("up").ontouchend=()=>flyUp=false;
  document.getElementById("down").ontouchstart=()=>flyDown=true;
  document.getElementById("down").ontouchend=()=>flyDown=false;

  let lx,ly;
  document.addEventListener("touchstart",e=>{
    if(e.touches[0].clientX > window.innerWidth/2){
      lx=e.touches[0].clientX;
      ly=e.touches[0].clientY;
    }
  });

  document.addEventListener("touchmove",e=>{
    if(e.touches[0].clientX <= window.innerWidth/2) return;
    const t=e.touches[0];
    yaw -= (t.clientX-lx)*0.002;
    pitch -= (t.clientY-ly)*0.002;
    pitch=Math.max(-Math.PI/2,Math.min(Math.PI/2,pitch));
    lx=t.clientX; ly=t.clientY;
  });

  document.getElementById("colorPicker")
    .oninput=e=>currentColor=e.target.value;
}

function updateCamera(){
  const dir = new THREE.Vector3(
    Math.sin(yaw)*Math.cos(pitch),
    Math.sin(pitch),
    Math.cos(yaw)*Math.cos(pitch)
  );
  camera.position.set(player.x,player.y+2.32,player.z);
  camera.lookAt(
    player.x+dir.x,
    player.y+2.32+dir.y,
    player.z+dir.z
  );
}

function animate(){
  requestAnimationFrame(animate);

  const speed=0.045;
  const forward=-my*speed;
  const strafe=mx*speed;

  player.x+=Math.sin(yaw)*forward+Math.cos(yaw+Math.PI/2)*strafe;
  player.z+=Math.cos(yaw)*forward-Math.sin(yaw+Math.PI/2)*strafe;

  if(flyUp) player.y+=0.5;
  if(flyDown) player.y-=0.5;

  updateCamera();
  renderer.render(scene,camera);
}
</script>
</body>
</html>
